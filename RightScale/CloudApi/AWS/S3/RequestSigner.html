<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: RightScale::CloudApi::AWS::S3::RequestSigner
  
    &mdash; Documentation by YARD 0.8.7.4
  
</title>

  <link rel="stylesheet" href="../../../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '../../../../';
  framesUrl = "../../../../frames.html#!RightScale/CloudApi/AWS/S3/RequestSigner.html";
</script>


  <script type="text/javascript" charset="utf-8" src="../../../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../../../js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="../../../../_index.html">Index (R)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../../RightScale.html" title="RightScale (module)">RightScale</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../../CloudApi.html" title="RightScale::CloudApi (module)">CloudApi</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../AWS.html" title="RightScale::CloudApi::AWS (module)">AWS</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../S3.html" title="RightScale::CloudApi::AWS::S3 (module)">S3</a></span></span>
     &raquo; 
    <span class="title">RequestSigner</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../../class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="../../../../method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="../../../../file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: RightScale::CloudApi::AWS::S3::RequestSigner
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">CloudApi::Routine</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">CloudApi::Routine</li>
          
            <li class="next">RightScale::CloudApi::AWS::S3::RequestSigner</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/cloud/aws/s3/routines/request_signer.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>S3 Request signer</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="RequestSigner/Error.html" title="RightScale::CloudApi::AWS::S3::RequestSigner::Error (class)">Error</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="SUB_RESOURCES-constant" class="">SUB_RESOURCES =
          <div class="docstring">
  <div class="discussion">
    
<p>This guys are used to sign a request</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='qwords_beg'>%w{
</span><span class='tstring_content'>acl</span><span class='words_sep'>
</span><span class='tstring_content'>cors</span><span class='words_sep'>
</span><span class='tstring_content'>delete</span><span class='words_sep'>
</span><span class='tstring_content'>lifecycle</span><span class='words_sep'>
</span><span class='tstring_content'>location</span><span class='words_sep'>
</span><span class='tstring_content'>logging</span><span class='words_sep'>
</span><span class='tstring_content'>notification</span><span class='words_sep'>
</span><span class='tstring_content'>policy</span><span class='words_sep'>
</span><span class='tstring_content'>requestPayment</span><span class='words_sep'>
</span><span class='tstring_content'>tagging</span><span class='words_sep'>
</span><span class='tstring_content'>torrent</span><span class='words_sep'>
</span><span class='tstring_content'>uploads</span><span class='words_sep'>
</span><span class='tstring_content'>versionId</span><span class='words_sep'>
</span><span class='tstring_content'>versioning</span><span class='words_sep'>
</span><span class='tstring_content'>versions</span><span class='words_sep'>
</span><span class='tstring_end'>website</span></span></pre></dd>
      
        <dt id="OVERRIDE_RESPONSE_HEADERS-constant" class="">OVERRIDE_RESPONSE_HEADERS =
          <div class="docstring">
  <div class="discussion">
    
<p>Using Query String API Amazon allows to override some of response headers:</p>

<p>response-content-type response-content-language response-expires
reponse-cache-control response-content-disposition
response-content-encoding</p>


  </div>
</div>
<div class="tags">
  

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="http://docs.amazonwebservices.com/AmazonS3/latest/API/RESTObjectGET.html?r=2145" target="_parent" title="http://docs.amazonwebservices.com/AmazonS3/latest/API/RESTObjectGET.html?r=2145">http://docs.amazonwebservices.com/AmazonS3/latest/API/RESTObjectGET.html?r=2145</a></li>
    
  </ul>

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^response-</span><span class='regexp_end'>/</span></span></pre></dd>
      
        <dt id="ONE_YEAR_OF_SECONDS-constant" class="">ONE_YEAR_OF_SECONDS =
          <div class="docstring">
  <div class="discussion">
    
<p>One year in seconds</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>365</span><span class='op'>*</span><span class='int'>60</span><span class='op'>*</span><span class='int'>60</span><span class='op'>*</span><span class='int'>24</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#process-instance_method" title="#process (instance method)">- (void) <strong>process</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Authenticates an S3 request.</p>
</div></span>
  
</li>

      
    </ul>
  


  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="process-instance_method">
  
    - (<tt>void</tt>) <strong>process</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p class="note returns_void">This method returns an undefined value.</p>
<p>Authenticates an S3 request</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <p class="tag_title">Examples:</p>
    
      
      <pre class="example code"><code><span class='comment'># no example</span></code></pre>
    
  </div>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/cloud/aws/s3/routines/request_signer.rb', line 76</span>

<span class='kw'>def</span> <span class='id identifier rubyid_process'>process</span>
  <span class='comment'># Extract sub-resource(s).
</span>  <span class='comment'># Sub-resources are acl, torrent, versioning, location etc.
</span>  <span class='id identifier rubyid_sub_resources'>sub_resources</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span>
  <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:params</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_key'>key</span><span class='comma'>,</span> <span class='id identifier rubyid_value'>value</span><span class='op'>|</span>
    <span class='id identifier rubyid_sub_resources'>sub_resources</span><span class='lbracket'>[</span><span class='id identifier rubyid_key'>key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_value'>value</span><span class='period'>.</span><span class='id identifier rubyid__blank?'>_blank?</span> <span class='op'>?</span> <span class='kw'>nil</span> <span class='op'>:</span> <span class='id identifier rubyid_value'>value</span><span class='rparen'>)</span> <span class='kw'>if</span> <span class='const'>SUB_RESOURCES</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_key'>key</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_key'>key</span><span class='lbracket'>[</span><span class='const'>OVERRIDE_RESPONSE_HEADERS</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='comment'># Escape that part of the path that may have UTF-8 chars (in S3 Object name for instance).
</span>  <span class='comment'># Amazon wants them to be escaped before we sign the request.
</span>  <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='const'>AWS</span><span class='op'>::</span><span class='id identifier rubyid_amz_escape'>amz_escape</span><span class='lparen'>(</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># Extract bucket name and object path
</span>  <span class='kw'>if</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:bucket</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid__blank?'>_blank?</span>
    <span class='comment'># This is a very first attempt:
</span>    <span class='comment'># 1. extract the bucket name from the path
</span>    <span class='comment'># 2. save the bucket into request data vars
</span>    <span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='comma'>,</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lbracket'>[</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^([^\/]*)\/?(.*)$</span><span class='regexp_end'>/</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='lbracket'>[</span><span class='backref'>$1</span><span class='comma'>,</span> <span class='backref'>$2</span><span class='rbracket'>]</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:bucket</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_bucket_name'>bucket_name</span>
    <span class='comment'># Static path is the path that the original URL has.
</span>    <span class='comment'># 1. For Amazon it is always &#39;&#39;.
</span>    <span class='comment'># 2. For Euca it is usually a non-blank string.
</span>    <span class='id identifier rubyid_static_path'>static_path</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span>
    <span class='comment'># Add trailing &#39;/&#39; to the path unless it is.
</span>    <span class='id identifier rubyid_static_path'>static_path</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_static_path'>static_path</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>unless</span> <span class='id identifier rubyid_static_path'>static_path</span><span class='lbracket'>[</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\/$</span><span class='regexp_end'>/</span></span><span class='rbracket'>]</span>
    <span class='comment'># Store the path: we may need it for signing redirects later.
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:static_path</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_static_path'>static_path</span>
  <span class='kw'>else</span>
    <span class='comment'># This is a retry or a redirect:
</span>    <span class='comment'># 1. Extract the bucket name from the request data;
</span>    <span class='comment'># 2. Get rid of the path the remote server sent in the location header. We are
</span>    <span class='comment'>#    re-signing the request and have to build everything from the scratch.
</span>    <span class='comment'>#    In the crazy case when the new location has path differs from the original one
</span>    <span class='comment'>#    we are screwed up and we will get &quot;SignatureDoesNotMatch&quot; error. But this does
</span>    <span class='comment'>#    not seem to be the case for Amazon or Euca.
</span>    <span class='id identifier rubyid_bucket_name'>bucket_name</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:bucket</span><span class='rbracket'>]</span>
    <span class='comment'># Revert static path back to the original value.
</span>    <span class='id identifier rubyid_static_path'>static_path</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:static_path</span><span class='rbracket'>]</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span> <span class='op'>=</span> <span class='id identifier rubyid_static_path'>static_path</span>
  <span class='kw'>end</span>

  <span class='comment'># Calculate a canonical path (bucket part must end with &#39;/&#39;)
</span>  <span class='id identifier rubyid_bucket_string'>bucket_string</span>      <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='const'>AWS</span><span class='op'>::</span><span class='id identifier rubyid_is_dns_bucket?'>is_dns_bucket?</span><span class='lparen'>(</span><span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
  <span class='id identifier rubyid_canonicalized_path'>canonicalized_path</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='id identifier rubyid_join_urn'>join_urn</span><span class='lparen'>(</span><span class='id identifier rubyid_static_path'>static_path</span><span class='comma'>,</span>
                                       <span class='id identifier rubyid_bucket_string'>bucket_string</span><span class='comma'>,</span>
                                       <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                       <span class='id identifier rubyid_sub_resources'>sub_resources</span> <span class='rparen'>)</span><span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_value'>value</span><span class='op'>|</span> <span class='id identifier rubyid_value'>value</span> <span class='rbrace'>}</span> <span class='comment'># pass this block to avoid escaping: Amazon does not like escaped things in canonicalized_path
</span>  
  <span class='comment'># Make sure headers required for authentication are set
</span>  <span class='kw'>unless</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:options</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:cloud</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:link</span><span class='rbracket'>]</span>
    <span class='comment'># Make sure &#39;content-type&#39; is set.
</span>    <span class='comment'># P.S. Ruby 2.1+ sets &#39;content-type&#39; by default for POST and PUT requests.
</span>    <span class='comment'>#      So we need to include it into our signature to avoid the error below:
</span>    <span class='comment'>#      &#39;The request signature we calculated does not match the signature you provided.
</span>    <span class='comment'>#       Check your key and signing method.&#39;
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_set_if_blank'>set_if_blank</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>content-type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>application/octet-stream</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='comment'># REST Auth:
</span>    <span class='kw'>unless</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:body</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid__blank?'>_blank?</span>
      <span class='comment'># Fix body if it is a Hash instance
</span>      <span class='kw'>if</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:body</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Hash</span><span class='rparen'>)</span>
        <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:body</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='id identifier rubyid_contentify_body'>contentify_body</span><span class='lparen'>(</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:body</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>content-type</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='comment'># Calculate &#39;content-md5&#39; when possible (some API calls wanna have it set)
</span>      <span class='kw'>if</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:body</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>String</span><span class='rparen'>)</span>
        <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>content-md5</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='op'>::</span><span class='id identifier rubyid_encode64'>encode64</span><span class='lparen'>(</span><span class='const'>Digest</span><span class='op'>::</span><span class='const'>MD5</span><span class='op'>::</span><span class='id identifier rubyid_digest'>digest</span><span class='lparen'>(</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:body</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>
    <span class='comment'># Set date
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_set_if_blank'>set_if_blank</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>date</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='const'>Time</span><span class='op'>::</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='period'>.</span><span class='id identifier rubyid_httpdate'>httpdate</span><span class='rparen'>)</span>
    <span class='comment'># Sign a request
</span>    <span class='id identifier rubyid_signature'>signature</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='const'>AWS</span><span class='op'>::</span><span class='id identifier rubyid_sign_s3_signature'>sign_s3_signature</span><span class='lparen'>(</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:credentials</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:aws_secret_access_key</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                               <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:verb</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                               <span class='id identifier rubyid_canonicalized_path'>canonicalized_path</span><span class='comma'>,</span>
                                               <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>authorization</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>AWS </span><span class='embexpr_beg'>#{</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:credentials</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:aws_access_key_id</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_signature'>signature</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>else</span>
    <span class='comment'># @see http://docs.amazonwebservices.com/AmazonS3/latest/dev/RESTAuthentication.html
</span>    <span class='comment'># 
</span>    <span class='comment'># Amazon: ... We assume that when a browser makes the GET request, it won&#39;t provide a Content-MD5 or a Content-Type header, 
</span>    <span class='comment'>#  nor will it set any x-amz- headers, so those parts of the StringToSign are left blank. ...
</span>    <span class='comment'>#  
</span>    <span class='comment'># Only GET requests!
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Error</span><span class='op'>::</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Only GET requests are supported by S3 Query String API</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:verb</span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='symbol'>:get</span>
    <span class='comment'># Expires
</span>    <span class='id identifier rubyid_expires'>expires</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='id identifier rubyid_dearrayify'>dearrayify</span><span class='lparen'>(</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>expires</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>+</span> <span class='const'>ONE_YEAR_OF_SECONDS</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_expires'>expires</span> <span class='op'>=</span> <span class='id identifier rubyid_expires'>expires</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='kw'>unless</span> <span class='id identifier rubyid_expires'>expires</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Fixnum</span><span class='rparen'>)</span>
    <span class='comment'># QUERY STRING AUTH: (&#39;expires&#39; and &#39;x-amz-*&#39; headers are not supported)
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:params</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Expires</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>  <span class='op'>=</span> <span class='id identifier rubyid_expires'>expires</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>expires</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_expires'>expires</span> <span class='comment'># a hack to sign a record
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_dup'>dup</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_header'>header</span><span class='comma'>,</span> <span class='id identifier rubyid_values'>values</span><span class='op'>|</span>
      <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='id identifier rubyid_header'>header</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_header'>header</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lbracket'>[</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(^x-amz-)|(^expires$)</span><span class='regexp_end'>/</span></span><span class='rbracket'>]</span>
    <span class='kw'>end</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:params</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>AWSAccessKeyId</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:credentials</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:aws_access_key_id</span><span class='rbracket'>]</span>
    <span class='comment'># Sign a request
</span>    <span class='id identifier rubyid_signature'>signature</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='const'>AWS</span><span class='op'>::</span><span class='id identifier rubyid_sign_s3_signature'>sign_s3_signature</span><span class='lparen'>(</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:credentials</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:aws_secret_access_key</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                               <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:verb</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                               <span class='id identifier rubyid_canonicalized_path'>canonicalized_path</span><span class='comma'>,</span>
                                               <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span> <span class='rparen'>)</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:params</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Signature</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_signature'>signature</span>
    <span class='comment'># we dont need this header any more
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>expires</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>
  
  <span class='comment'># Sub-domain compatible buckets vs incompatible ones
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:options</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:cloud</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:no_subdomains</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='const'>Utils</span><span class='op'>::</span><span class='const'>AWS</span><span class='op'>::</span><span class='id identifier rubyid_is_dns_bucket?'>is_dns_bucket?</span><span class='lparen'>(</span><span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='rparen'>)</span>
    <span class='comment'># DNS compatible bucket name:
</span>    <span class='comment'>#
</span>    <span class='comment'># Figure out if we need to add bucket name into the host name. It is rediculous but
</span>    <span class='comment'># sometimes Amazon returns a redirect to a host with the bucket name already mixed in
</span>    <span class='comment'># but sometimes without.
</span>    <span class='comment'># The only thing we can do so far is to check if the host name starts with the bucket
</span>    <span class='comment'># and the name is at least 4th level DNS name.
</span>    <span class='comment'>#
</span>    <span class='comment'># Examples:
</span>    <span class='comment'>#   * my-bucket.s3-ap-southeast-2.amazonaws.com
</span>    <span class='comment'>#   * my-bucket.s3.amazonaws.com
</span>    <span class='comment'>#   * s3.amazonaws.com
</span>    <span class='comment'>#
</span>    <span class='comment'># P.S. This assumtion will not work for any other providers but we will figure it out later
</span>    <span class='comment'>#      if we support any. The only other provider we support is Eucalyptus but it always
</span>    <span class='comment'>#      expects that the bucket goes into path and never into the host therefore we are
</span>    <span class='comment'>#      OK with Euca (Euca is expected to be run with :no_subdomains =&gt; true).
</span>    <span class='comment'>#
</span>    <span class='kw'>unless</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='lbracket'>[</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>^</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>\..+\.[^.]+\.[^.]+$</span><span class='regexp_end'>/</span></span><span class='rbracket'>]</span>
      <span class='comment'># If there was a redirect and it had &#39;location&#39; header then there is nothing to do with the host
</span>      <span class='comment'># otherwise we have to add the bucket to the host.
</span>      <span class='comment'># P.S. When Amazon returns a redirect (usually 301) with the new host in the message body
</span>      <span class='comment'># the new host does not have the bucket name in it. But if it is 307 and the host is in the location
</span>      <span class='comment'># header then that host name already includes the bucket in it. Grrrr....
</span>      <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='embexpr_beg'>#{</span><span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='id identifier rubyid_join_urn'>join_urn</span><span class='lparen'>(</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span>
                                              <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                              <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:params</span><span class='rbracket'>]</span> <span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='comment'># Old incompatible or Eucalyptus
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Utils</span><span class='op'>::</span><span class='id identifier rubyid_join_urn'>join_urn</span><span class='lparen'>(</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span>
                                              <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bucket_name'>bucket_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                                              <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:relative_path</span><span class='rbracket'>]</span><span class='comma'>,</span>
                                              <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:params</span><span class='rbracket'>]</span> <span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Host should be set for REST requests (and should not affect on Query String ones)
</span>  <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>host</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span>
  
  <span class='comment'># Finalize data
</span>  <span class='kw'>if</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:options</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:cloud</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:link</span><span class='rbracket'>]</span>
    <span class='comment'># Amazon supports only some GET requests without body and any headers:
</span>    <span class='comment'># Return the link
</span>    <span class='id identifier rubyid_uri'>uri</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:connection</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:uri</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_clone'>clone</span>
    <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='comma'>,</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:path</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>?</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:result</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>verb</span><span class='tstring_end'>&quot;</span></span>    <span class='op'>=&gt;</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:verb</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>link</span><span class='tstring_end'>&quot;</span></span>    <span class='op'>=&gt;</span> <span class='id identifier rubyid_uri'>uri</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>headers</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:request</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:headers</span><span class='rbracket'>]</span>
    <span class='rbrace'>}</span>
    <span class='comment'># Query Auth:we should stop here because we just generated a link for the third part usage
</span>    <span class='ivar'>@data</span><span class='lbracket'>[</span><span class='symbol'>:vars</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:system</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:done</span><span class='rbracket'>]</span>   <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Fri Apr 25 16:24:39 2014 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.4 (ruby-2.1.0).
</div>

  </body>
</html>